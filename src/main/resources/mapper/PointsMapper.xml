<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.smxy.forum.mapper.PointsMapper">

    <select id="getUserPointsRank" resultType="userPointsRankVo">
        SELECT
            t1.user_id,
            t1.nick_name,
            t1.points,
            t1.avatar,
            IFNULL(t2.comment_num, 0) AS comment_num,
            IFNULL(t3.post_num, 0) AS post_num
        FROM
            user t1
                LEFT JOIN (
                SELECT
                    user_id,
                    COUNT(comment_id) AS comment_num
                FROM
                    comment
                WHERE
                    del_flag = 0
                GROUP BY
                    user_id
            ) t2
                          ON t1.user_id = t2.user_id
                LEFT JOIN (
                SELECT
                    user_id,
                    COUNT(t4.post_id) AS post_num
                FROM
                    post t4
                left join
                    post_audit t5
                on
                    t4.post_id = t5.post_id
                WHERE
                    t5.audit_status = 1
                AND
                    t4.del_flag = 0
                GROUP BY
                    user_id
            ) t3 ON t1.user_id = t3.user_id
        WHERE
            t1.del_flag = 0
        ORDER BY
            t1.points DESC,t1.create_time ASC
    </select>

</mapper>
